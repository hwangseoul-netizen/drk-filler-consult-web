<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>닥터케이 필러 상담</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Supabase v1 UMD (클라이언트용) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"
      defer
    ></script>

    <style>
      :root {
        --bg: #f7f7fa;
        --card: #ffffff;
        --primary: #ff4fa3;
        --primary-soft: #ffe5f4;
        --text-main: #111827;
        --text-sub: #6b7280;
        --border-soft: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        color: var(--text-main);
      }

      .app {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
        padding-bottom: 80px;
      }

      /* HEADER */
      header {
        margin-bottom: 16px;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      .k-badge {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .k-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
      }

      .k-text-title {
        font-weight: 800;
        font-size: 18px;
      }

      .k-text-sub {
        font-size: 11px;
        color: var(--text-sub);
      }

      .mode-toggle {
        display: flex;
        background: #f3f4f6;
        border-radius: 999px;
        padding: 3px;
      }

      .mode-btn {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 11px;
        padding: 6px 8px;
        border-radius: 999px;
        color: var(--text-sub);
        font-weight: 600;
        cursor: pointer;
      }

      .mode-btn.active {
        background: #111827;
        color: #fff;
      }

      .headline {
        margin-bottom: 12px;
      }

      .headline-title {
        font-size: 24px;
        font-weight: 800;
        margin: 0 0 6px;
      }

      .headline-text {
        font-size: 13px;
        color: var(--text-sub);
        line-height: 1.4;
      }

      /* CARD */
      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
        margin-bottom: 14px;
      }

      .step-title {
        font-weight: 800;
        margin-bottom: 6px;
        font-size: 15px;
      }

      .label {
        font-size: 13px;
        color: var(--text-sub);
        margin-bottom: 6px;
      }

      textarea,
      select,
      input[type="file"],
      input[type="text"] {
        width: 100%;
        font-family: inherit;
        font-size: 14px;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        padding: 8px 10px;
        outline: none;
      }

      textarea {
        min-height: 70px;
        resize: vertical;
      }

      textarea:focus,
      select:focus,
      input[type="file"]:focus,
      input[type="text"]:focus {
        border-color: var(--primary);
      }

      .file-row {
        margin-bottom: 8px;
      }

      .file-label-inline {
        font-size: 12px;
        color: var(--text-sub);
        margin-bottom: 4px;
      }

      .btn-primary {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 12px;
        font-size: 15px;
        font-weight: 800;
        background: var(--primary);
        color: #fff;
        cursor: pointer;
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .helper-text {
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-sub);
      }

      .hidden {
        display: none;
      }

      .status-text {
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-sub);
      }

      /* Doctor 모드 레이아웃 */
      .doctor-layout {
        display: flex;
        gap: 12px;
      }

      @media (max-width: 768px) {
        .doctor-layout {
          flex-direction: column;
        }
      }

      .doctor-list {
        flex: 1;
        min-width: 0;
      }

      .doctor-detail {
        flex: 1.2;
        min-width: 0;
      }

      .case-item {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        margin-bottom: 8px;
        cursor: pointer;
        background: #f9fafb;
      }

      .case-item:hover {
        background: #eef2ff;
      }

      .case-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .case-meta {
        font-size: 11px;
        color: var(--text-sub);
      }

      .badge-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        margin-left: 6px;
      }

      .badge-new {
        background: #fee2e2;
        color: #991b1b;
      }

      .badge-done {
        background: #dcfce7;
        color: #166534;
      }

      .thumb-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .thumb-row img {
        width: calc(50% - 4px);
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        object-fit: cover;
      }

      .doctor-textarea {
        margin-top: 10px;
        font-size: 13px;
      }

      .btn-secondary {
        width: auto;
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 700;
        background: var(--primary-soft);
        color: #9d174d;
        cursor: pointer;
      }

      .top-right-small {
        font-size: 11px;
        color: var(--text-sub);
        text-align: right;
        margin-bottom: 4px;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <header>
        <div class="header-top">
          <div class="k-badge">
            <div class="k-circle">K</div>
            <div>
              <div class="k-text-title">닥터케이 필러 상담</div>
              <div class="k-text-sub">전신 필러 전문 온라인 프리 상담</div>
            </div>
          </div>

          <div class="mode-toggle">
            <button
              id="btn-user-mode"
              class="mode-btn active"
              type="button"
            >
              사용자 모드
            </button>
            <button
              id="btn-doctor-mode"
              class="mode-btn"
              type="button"
            >
              닥터 모드
            </button>
          </div>
        </div>

        <div class="headline">
          <p class="headline-title">“이거 필러로 돼요? 얼마나 넣어야 해요?”</p>
          <p class="headline-text">
            전신을 필러로 다뤄온 닥터케이가 온라인에서 방향을 잡아주는
            상담입니다.<br />
            실시간 채팅은 아니지만, 탑 티어 답변을 기다리는 맛이 있어!
          </p>
        </div>
      </header>

      <!-- 사용자 모드 -->
      <main id="user-mode-section">
        <form id="user-form">
          <!-- 1단계 -->
          <div class="card">
            <div class="step-title">1단계 · 어디가 제일 고민이야?</div>
            <div class="label">관심 부위 (자유 입력)</div>
            <textarea
              id="part"
              placeholder="예: 골반필러, 힙딥, 어깨, 가슴골 등"
            ></textarea>

            <div class="label" style="margin-top: 10px">
              지금 제일 고민되는 부분
            </div>
            <textarea
              id="concern"
              placeholder="예: 골반이 너무 얇아서 라인이 없어요 등"
            ></textarea>
          </div>

          <!-- 2단계 -->
          <div class="card">
            <div class="step-title">2단계 · 바뀌었으면 하는 느낌/이미지</div>
            <div class="label">원하는 분위기 / 이미지</div>
            <textarea
              id="goal"
              placeholder="예: 자연스러운 볼륨, 라운드 느낌 등"
            ></textarea>

            <div class="label" style="margin-top: 10px">
              3단계 · 어느 정도까지 바꾸고 싶어?
            </div>
            <select id="change_level">
              <option value="">선택</option>
              <option value="soft">살짝 티만</option>
              <option value="clear">확실하게</option>
              <option value="image">이미지 체인지급</option>
            </select>
          </div>

          <!-- 사진 업로드 -->
          <div class="card">
            <div class="step-title">
              4단계 · 본인 사진 업로드 (정면 / 좌45 / 우45 / 후면)
            </div>
            <div class="label">
              지금은 파일 선택 후 업로드, 보안 처리는 서버 쪽에서 추가 예정이야.
            </div>

            <div class="file-row">
              <div class="file-label-inline">정면</div>
              <input type="file" id="photo-front" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label-inline">좌 45°</div>
              <input type="file" id="photo-left" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label-inline">우 45°</div>
              <input type="file" id="photo-right" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label-inline">후면</div>
              <input type="file" id="photo-back" accept="image/*" />
            </div>

            <div class="label" style="margin-top: 8px">
              참고 전후 이미지 메모 (선택)
            </div>
            <textarea
              id="refnote"
              placeholder="예: 인스타에서 본 전후 느낌 / 본인이 보정한 후사진 설명 등"
            ></textarea>

            <button
              type="submit"
              class="btn-primary"
              id="btn-submit-user"
              style="margin-top: 16px"
            >
              상담 보내기
            </button>

            <div class="helper-text" id="user-helper">
              업로드 중일 땐 아래에 “업로드 중...” 메시지가 뜰 거야.
            </div>
            <div class="status-text" id="user-status"></div>
          </div>
        </form>
      </main>

      <!-- 닥터 모드 -->
      <main id="doctor-mode-section" class="hidden">
        <div class="top-right-small">
          전국에서 올라오는 “이거 필러로 돼요?” 케이스 대기함
        </div>
        <div class="card">
          <div class="step-title">닥터케이 대기함</div>
          <div
            class="label"
            style="margin-bottom: 10px"
          >
            실시간 채팅이 아니라, 차트 보듯이 하나씩 열어서 답변 남기는 구조라고
            생각하면 돼.
          </div>

          <div class="doctor-layout">
            <div class="doctor-list">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <span class="label">대기 중 케이스</span>
                <button
                  type="button"
                  class="btn-secondary"
                  id="btn-refresh-cases"
                >
                  새로고침
                </button>
              </div>
              <div id="case-list"></div>
            </div>

            <div class="doctor-detail" id="case-detail">
              <div class="label">케이스를 왼쪽에서 선택해줘.</div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ====== Supabase 설정 ======
      const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
      const SUPABASE_KEY =
        "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";
      const BUCKET_NAME = "drk-photos";

      let sbClient;

      document.addEventListener("DOMContentLoaded", () => {
        // Supabase 클라이언트 생성 (v1)
        sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 모드 토글
        const userBtn = document.getElementById("btn-user-mode");
        const doctorBtn = document.getElementById("btn-doctor-mode");
        const userSection = document.getElementById("user-mode-section");
        const doctorSection = document.getElementById("doctor-mode-section");

        userBtn.addEventListener("click", () => {
          userBtn.classList.add("active");
          doctorBtn.classList.remove("active");
          userSection.classList.remove("hidden");
          doctorSection.classList.add("hidden");
        });

        doctorBtn.addEventListener("click", () => {
          doctorBtn.classList.add("active");
          userBtn.classList.remove("active");
          userSection.classList.add("hidden");
          doctorSection.classList.remove("hidden");
          loadCases();
        });

        // 사용자 폼 submit
        document
          .getElementById("user-form")
          .addEventListener("submit", handleUserSubmit);

        // 닥터 모드 새로고침
        document
          .getElementById("btn-refresh-cases")
          .addEventListener("click", loadCases);
      });

      // ====== 파일 업로드 유틸 ======
      async function uploadFileIfExists(inputId, caseSlug, position) {
        const input = document.getElementById(inputId);
        if (!input || !input.files || input.files.length === 0) return null;

        const file = input.files[0];
        const ext =
          file.name.split(".").length > 1
            ? file.name.split(".").pop()
            : "jpg";
        const path = `cases/${caseSlug}_${position}.${ext}`;

        const { data, error } = await sbClient.storage
          .from(BUCKET_NAME)
          .upload(path, file, {
            upsert: true,
          });

        if (error) {
          console.error("파일 업로드 실패:", error.message);
          throw error;
        }

        const { publicURL } = sbClient.storage
          .from(BUCKET_NAME)
          .getPublicUrl(path);

        return publicURL || null;
      }

      // ====== 사용자 모드: 상담 보내기 ======
      async function handleUserSubmit(e) {
        e.preventDefault();
        const statusEl = document.getElementById("user-status");
        const helperEl = document.getElementById("user-helper");
        const btn = document.getElementById("btn-submit-user");

        const part = document.getElementById("part").value.trim();
        const concern = document.getElementById("concern").value.trim();
        const goal = document.getElementById("goal").value.trim();
        const changeLevel =
          document.getElementById("change_level").value || "";
        const refnote = document.getElementById("refnote").value.trim();

        if (!part || !concern) {
          alert("관심 부위랑 고민되는 부분은 꼭 적어줘!");
          return;
        }

        btn.disabled = true;
        statusEl.textContent = "업로드 중... 잠시만 기다려줘!";
        helperEl.textContent = "";

        const slug = `case_${Date.now()}`;

        try {
          // 1) 사진 업로드 (있는 것만)
          const [front, left, right, back] = await Promise.all([
            uploadFileIfExists("photo-front", slug, "front"),
            uploadFileIfExists("photo-left", slug, "left"),
            uploadFileIfExists("photo-right", slug, "right"),
            uploadFileIfExists("photo-back", slug, "back"),
          ]);

          // 2) DB insert
          const { data, error } = await sbClient
            .from("cases")
            .insert([
              {
                part,
                concern,
                goal,
                change_level: changeLevel,
                refnote,
                status: "new",
                photos_front: front,
                photos_left: left,
                photos_right: right,
                photos_back: back,
              },
            ])
            .select();

          if (error) {
            console.error("케이스 저장 실패:", error.message);
            throw error;
          }

          statusEl.textContent =
            "상담 접수 완료! 닥터케이가 차례대로 보고 답변 남길게.";
          // 폼 리셋
          document.getElementById("user-form").reset();
        } catch (err) {
          console.error(err);
          statusEl.textContent =
            "업로드 중 오류가 났어. 잠시 후 다시 시도해줘.";
        } finally {
          btn.disabled = false;
        }
      }

      // ====== 닥터 모드: 케이스 로드 ======
      async function loadCases() {
        const listEl = document.getElementById("case-list");
        const detailEl = document.getElementById("case-detail");
        listEl.innerHTML = '<div class="label">불러오는 중...</div>';

        const { data, error } = await sbClient
          .from("cases")
          .select("*")
          .order("created_at", { ascending: false })
          .limit(100);

        if (error) {
          console.error("케이스 불러오기 실패:", error.message);
          listEl.innerHTML =
            '<div class="label">불러오기 실패. 콘솔 에러 확인 필요.</div>';
          return;
        }

        if (!data || data.length === 0) {
          listEl.innerHTML =
            '<div class="label">아직 접수된 케이스가 없어.</div>';
          detailEl.innerHTML =
            '<div class="label">상세를 보려면 케이스가 필요해.</div>';
          return;
        }

        listEl.innerHTML = "";
        data.forEach((c) => {
          const div = document.createElement("div");
          div.className = "case-item";
          const created = c.created_at
            ? new Date(c.created_at).toLocaleString("ko-KR", {
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
              })
            : "";
          const statusClass =
            c.status === "done" ? "badge-status badge-done" : "badge-status badge-new";
          const statusLabel = c.status === "done" ? "답변완료" : "대기";

          div.innerHTML = `
            <div class="case-title">
              ${c.part || "부위 미입력"}
              <span class="${statusClass}">${statusLabel}</span>
            </div>
            <div class="case-meta">${created} · ${
            (c.change_level || "").toUpperCase()
          }</div>
            <div class="case-meta">고민: ${
              c.concern ? c.concern.slice(0, 30) + "..." : "—"
            }</div>
          `;
          div.addEventListener("click", () => showCaseDetail(c));
          listEl.appendChild(div);
        });

        // 첫 번째 케이스 자동 선택
        showCaseDetail(data[0]);
      }

      // ====== 닥터 모드: 상세 + 답변 ======
      function showCaseDetail(c) {
        const detailEl = document.getElementById("case-detail");
        if (!c) {
          detailEl.innerHTML =
            '<div class="label">케이스를 선택해줘.</div>';
          return;
        }

        const photos = [
          { label: "정면", url: c.photos_front },
          { label: "좌 45°", url: c.photos_left },
          { label: "우 45°", url: c.photos_right },
          { label: "후면", url: c.photos_back },
        ].filter((p) => p.url);

        const created = c.created_at
          ? new Date(c.created_at).toLocaleString("ko-KR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "";

        detailEl.innerHTML = `
          <div class="step-title">선택된 케이스</div>
          <div class="label">${created}</div>
          <div class="label">부위</div>
          <div class="card" style="margin-bottom:8px;">${c.part || "—"}</div>

          <div class="label">고민 내용</div>
          <div class="card" style="margin-bottom:8px;">${
            c.concern || "—"
          }</div>

          <div class="label">바꾸고 싶은 느낌</div>
          <div class="card" style="margin-bottom:8px;">${c.goal || "—"}</div>

          <div class="label">변화 강도</div>
          <div class="card" style="margin-bottom:8px;">${
            c.change_level || "—"
          }</div>

          <div class="label">참고 전후/메모</div>
          <div class="card" style="margin-bottom:8px;">${
            c.refnote || "—"
          }</div>

          <div class="label">업로드된 사진</div>
          ${
            photos.length
              ? `<div class="thumb-row">
                  ${photos
                    .map(
                      (p) =>
                        `<div style="width:48%;">
                           <div class="file-label-inline">${p.label}</div>
                           <img src="${p.url}" alt="${p.label}" />
                         </div>`
                    )
                    .join("")}
                 </div>`
              : '<div class="card" style="margin-top:4px;">사진 업로드 없음</div>'
          }

          <div class="label" style="margin-top:10px;">닥터케이 답변 메모</div>
          <textarea id="doctor-reply" class="doctor-textarea" placeholder="예: 필러로 어느 정도 가능 / 볼륨 권장 cc 범위 / 난이도 / 주의점 등을 솔직하게 적어줘.">${
            c.refnote && c.status === "done" ? c.refnote : ""
          }</textarea>

          <button type="button" class="btn-secondary" id="btn-save-reply" style="margin-top:8px;">
            답변 저장 & 상태 완료로 변경
          </button>
        `;

        const btnSave = document.getElementById("btn-save-reply");
        btnSave.addEventListener("click", async () => {
          const reply = document
            .getElementById("doctor-reply")
            .value.trim();
          btnSave.disabled = true;
          btnSave.textContent = "저장 중...";

          const { error } = await sbClient
            .from("cases")
            .update({ refnote: reply, status: "done" })
            .eq("id", c.id);

          if (error) {
            console.error("답변 저장 실패:", error.message);
            alert("저장 실패. 콘솔 에러 확인 필요.");
          } else {
            alert("저장 완료! 리스트 상태도 새로고침해 줄게.");
            loadCases();
          }
        });
      }
    </script>
  </body>
</html>
