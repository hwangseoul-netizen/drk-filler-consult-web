<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
  const SUPABASE_KEY = "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ì—…ë¡œë“œ í•¨ìˆ˜
  async function uploadFile(file, pathName) {
    try {
      if (!file) return null;

      const fileExt = file.name.split(".").pop();
      const fileName = `${pathName}.${fileExt}`;
      const filePath = `${Date.now()}_${fileName}`;

      let { error } = await supabase.storage
        .from("drk-photos")
        .upload(filePath, file, {
          upsert: false,
        });

      if (error) {
        console.error("Upload error:", error);
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨! ë‹¤ì‹œ ì—…ë¡œë“œí•´ì¤˜ ğŸ™");
        return null;
      }

      const { data } = supabase.storage
        .from("drk-photos")
        .getPublicUrl(filePath);

      return data.publicUrl;
    } catch (e) {
      console.error("Upload exception:", e);
      return null;
    }
  }

  // ìƒë‹´ ì œì¶œ
  async function submitCase() {
    document.getElementById("loadingText").style.display = "block";

    const part = document.getElementById("part").value;
    const concern = document.getElementById("concern").value;
    const goal = document.getElementById("goal").value;
    const changeLevel = document.getElementById("changeLevel").value;

    const front = document.getElementById("photo_front").files[0];
    const left = document.getElementById("photo_left").files[0];
    const right = document.getElementById("photo_right").files[0];
    const back = document.getElementById("photo_back").files[0];

    const frontUrl = await uploadFile(front, "front");
    const leftUrl = await uploadFile(left, "left");
    const rightUrl = await uploadFile(right, "right");
    const backUrl = await uploadFile(back, "back");

    const { error } = await supabase.from("cases").insert({
      part,
      concern,
      goal,
      change_level: changeLevel,
      photos_front: frontUrl,
      photos_left: leftUrl,
      photos_right: rightUrl,
      photos_back: backUrl,
      status: "new",
      messages: [],
    });

    document.getElementById("loadingText").style.display = "none";

    if (error) {
      alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜! ë‹¤ì‹œ ì‹œë„í•´ì¤˜ ğŸ™");
      console.error(error);
      return;
    }

    alert("ìƒë‹´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆì–´! ìµœëŒ€í•œ ë¹¨ë¦¬ í™•ì¸í•´ë³¼ê²Œ ğŸ‘");
  }
</script>
