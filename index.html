<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>닥터케이 필러 상담</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
      :root {
        --bg: #f5f5f7;
        --card: #ffffff;
        --primary: #ff4f7d;
        --primary-soft: #ffe4ec;
        --border: #e5e5ea;
        --border-soft: #e5e7eb;
        --text-main: #111827;
        --text-sub: #6b7280;
        --danger: #ef4444;
        --success: #16a34a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        background: var(--bg);
        color: var(--text-main);
      }

      .app {
        max-width: 960px;
        margin: 0 auto;
        padding: 16px;
      }

      /* HEADER */

      .app-header {
        background: var(--card);
        border-radius: 18px;
        padding: 16px 16px 14px;
        border: 1px solid var(--border-soft);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .doc-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 800;
        font-size: 18px;
      }

      .title-area h1 {
        font-size: 18px;
        margin: 0 0 2px;
        font-weight: 800;
      }

      .title-area p {
        margin: 0;
        font-size: 12px;
        color: var(--text-sub);
      }

      .mode-toggle {
        background: #f2f2f7;
        border-radius: 999px;
        padding: 3px;
        display: inline-flex;
      }

      .mode-btn {
        border: none;
        background: transparent;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 13px;
        color: var(--text-sub);
        cursor: pointer;
      }

      .mode-btn.active {
        background: #ffffff;
        color: var(--primary);
        font-weight: 700;
        box-shadow: 0 0 0 1px var(--border);
      }

      .header-bottom {
        font-size: 13px;
        color: var(--text-sub);
        line-height: 1.5;
      }

      .header-bottom strong {
        color: var(--text-main);
      }

      /* LAYOUT */

      .main {
        margin-top: 16px;
        margin-bottom: 80px;
      }

      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid var(--border-soft);
        margin-bottom: 14px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 6px;
      }

      .card-sub {
        font-size: 12px;
        color: var(--text-sub);
        margin-bottom: 12px;
      }

      .step-label {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .step-caption {
        font-size: 12px;
        color: var(--text-sub);
        margin-bottom: 8px;
      }

      .field {
        margin-bottom: 12px;
      }

      .field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .field small {
        display: block;
        font-size: 11px;
        color: var(--text-sub);
        margin-top: 2px;
      }

      textarea,
      input[type="text"],
      select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 13px;
        font-family: inherit;
        resize: vertical;
        min-height: 40px;
        background: #fafafa;
        color: var(--text-main);
      }

      textarea::placeholder,
      input::placeholder {
        color: #9ca3af;
      }

      input[type="file"] {
        width: 100%;
        font-size: 12px;
      }

      .photo-row {
        margin-bottom: 10px;
      }

      .photo-row label {
        font-size: 13px;
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }

      .helper {
        font-size: 11px;
        color: var(--text-sub);
      }

      .btn-primary {
        width: 100%;
        border-radius: 999px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 700;
        padding: 12px;
        font-size: 15px;
        cursor: pointer;
      }

      .btn-primary:disabled {
        background: #e5e7eb;
        color: #9ca3af;
        cursor: default;
      }

      .status-text {
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-sub);
      }

      .status-text.ok {
        color: var(--success);
      }

      .status-text.err {
        color: var(--danger);
      }

      /* DOCTOR MODE */

      .doctor-header {
        font-size: 14px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
      }

      .doctor-header span {
        color: var(--text-sub);
        font-size: 12px;
      }

      .case-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
        max-height: 260px;
        overflow-y: auto;
      }

      .case-item {
        border-radius: 12px;
        border: 1px solid var(--border-soft);
        padding: 10px 12px;
        background: #f9fafb;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .case-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      .case-item-part {
        font-weight: 600;
      }

      .case-item-date {
        font-size: 11px;
        color: var(--text-sub);
      }

      .case-item-concern {
        font-size: 12px;
        color: var(--text-sub);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid transparent;
      }

      .badge-new {
        background: var(--primary-soft);
        color: var(--primary);
        border-color: var(--primary-soft);
      }

      .badge-done {
        background: #dcfce7;
        color: #166534;
        border-color: #bbf7d0;
      }

      .doctor-detail {
        margin-top: 6px;
      }

      .subsection-title {
        font-size: 13px;
        font-weight: 700;
        margin: 10px 0 4px;
      }

      .readonly {
        font-size: 13px;
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        padding: 10px 12px;
        white-space: pre-wrap;
      }

      .photo-links {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .photo-links a {
        font-size: 12px;
        color: var(--primary);
        text-decoration: none;
        padding: 4px 8px;
        border-radius: 999px;
        background: #f9fafb;
        border: 1px solid var(--border-soft);
      }

      .reply-history {
        max-height: 140px;
        overflow-y: auto;
        margin-bottom: 6px;
      }

      .reply-item {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 8px;
        background: #f9fafb;
        border: 1px solid var(--border-soft);
        margin-bottom: 4px;
      }

      .reply-item time {
        display: block;
        font-size: 10px;
        color: var(--text-sub);
      }

      .btn-small {
        border-radius: 999px;
        border: none;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-outline {
        background: #ffffff;
        border: 1px solid var(--border);
        color: var(--text-main);
      }

      .btn-save {
        background: var(--primary);
        color: #ffffff;
        border: none;
      }

      .btn-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }

      /* MODAL (PIN) */

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }

      .modal {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px 18px 14px;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      }

      .modal-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 6px;
      }

      .modal-text {
        font-size: 12px;
        color: var(--text-sub);
        margin-bottom: 10px;
      }

      .pin-input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .pin-input-row input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        text-align: center;
      }

      .modal-btn-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 4px;
      }

      .btn-cancel {
        background: #f3f4f6;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        padding: 8px 12px;
        cursor: pointer;
      }

      .btn-confirm {
        background: var(--primary);
        color: #fff;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        padding: 8px 14px;
        cursor: pointer;
      }

      .modal-error {
        font-size: 11px;
        color: var(--danger);
        min-height: 14px;
      }

      @media (min-width: 768px) {
        .app-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
        .header-bottom {
          max-width: 520px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- HEADER -->
      <header class="app-header">
        <div class="header-top">
          <div class="doc-info">
            <div class="avatar">K</div>
            <div class="title-area">
              <h1>닥터케이 필러 상담</h1>
              <p>전신 필러 전문 온라인 프리 상담</p>
            </div>
          </div>
          <div class="mode-toggle" id="modeToggle">
            <button
              type="button"
              class="mode-btn active"
              id="userModeBtn"
            >
              사용자 모드
            </button>
            <button type="button" class="mode-btn" id="doctorModeBtn">
              닥터 모드
            </button>
          </div>
        </div>
        <div class="header-bottom" id="headerDesc">
          <strong>“이거 필러로 돼요? 얼마나 넣어야 해요?”</strong><br />
          전신을 필러로 다뤄온 닥터케이가 온라인에서 방향을 잡아주는
          상담입니다.<br />
          실시간 채팅은 아니지만, <strong>탑 티어 답변을 원한다면 조금만
          기다려주세요!</strong>
        </div>
      </header>

      <!-- MAIN -->
      <main class="main">
        <!-- USER MODE -->
        <section id="userSection">
          <!-- STEP 1 -->
          <div class="card">
            <div class="card-title">1단계 · 어디가 제일 고민이야?</div>
            <div class="card-sub">관심 부위 / 키워드 + 지금 제일 고민되는 부분</div>

            <form id="consultForm">
              <div class="field">
                <label>관심 부위 / 키워드</label>
                <textarea
                  id="fieldPart"
                  placeholder="예: 골반필러, 힙딥, 어깨, 가슴골 등"
                ></textarea>
              </div>

              <div class="field">
                <label>지금 제일 고민되는 부분</label>
                <textarea
                  id="fieldConcern"
                  placeholder="예: 골반이 너무 얇아서 라인이 없어요 등"
                ></textarea>
              </div>

              <!-- STEP 2 -->
              <div class="step-label">2단계 · 바뀌었으면 하는 느낌/이미지</div>
              <div class="step-caption">
                원하는 분위기 / 이미지, 본인이 생각하는 목표 느낌을 적어줘.
              </div>

              <div class="field">
                <label>원하는 느낌 / 목표</label>
                <textarea
                  id="fieldGoal"
                  placeholder="예: 자연스럽게 골반 라운드 볼륨 / 손등은 나이티만 줄어든 정도 등"
                ></textarea>
              </div>

              <div class="field">
                <label>어느 정도까지 바꾸고 싶어?</label>
                <select id="fieldChangeLevel">
                  <option value="">선택</option>
                  <option value="standard">
                    표준 (주변에서 &ldquo;예뻐졌네?&rdquo; 하는 정도)
                  </option>
                  <option value="strong">
                    확실한 변화 (사진에서 바로 보이는 정도)
                  </option>
                  <option value="image-change">
                    이미지 체인지 (완전 다른 느낌)
                  </option>
                </select>
              </div>

              <!-- STEP 3 -->
              <div class="step-label">3단계 · 참고 이미지 & 메모</div>
              <div class="step-caption">
                다른 병원 전후, 셀카, 보정 이미지 등 뭐든 좋아. 편하게 올려줘.
              </div>

              <div class="field">
                <label>참고 전후/이미지 메모</label>
                <textarea
                  id="fieldRefNote"
                  placeholder="예: 인스타에서 본 전후 느낌 / 본인이 보정한 후사진 설명 등"
                ></textarea>
              </div>

              <div class="field">
                <label>사진 업로드 (정면 / 좌45° / 우45° / 후면)</label>
                <small class="helper">
                  지금은 테스트로 최대 4장까지 업로드 가능해. 얼굴/바디 모두 가능하고,
                  민감하면 얼굴은 가려도 돼.
                </small>

                <div class="photo-row">
                  <label>정면</label>
                  <input type="file" id="photoFront" accept="image/*" />
                </div>
                <div class="photo-row">
                  <label>좌 45°</label>
                  <input type="file" id="photoLeft" accept="image/*" />
                </div>
                <div class="photo-row">
                  <label>우 45°</label>
                  <input type="file" id="photoRight" accept="image/*" />
                </div>
                <div class="photo-row">
                  <label>후면</label>
                  <input type="file" id="photoBack" accept="image/*" />
                </div>
              </div>

              <button type="submit" class="btn-primary" id="submitBtn">
                상담 보내기
              </button>
              <div class="status-text" id="userStatus">
                업로드는 Wi-Fi 기준으로 수 초 정도 걸릴 수 있어요. 창 닫지 말고
                잠깐만 기다려주세요.
              </div>
            </form>
          </div>
        </section>

        <!-- DOCTOR MODE -->
        <section id="doctorSection" style="display: none">
          <div class="card">
            <div class="doctor-header">
              <div>
                <div class="card-title">닥터케이 대기함</div>
                <span>전국에서 올라온 &ldquo;이거 필러로 돼요?&rdquo; 케이스들을 보는
                  차트 뷰야.</span>
              </div>
              <button type="button" class="btn-small btn-outline" id="reloadBtn">
                새로고침
              </button>
            </div>

            <div class="case-list" id="caseList">
              <!-- 케이스 목록 -->
            </div>

            <div class="doctor-detail" id="doctorDetail" style="display: none">
              <div class="subsection-title">선택된 케이스</div>
              <div class="readonly" id="detailInfo"></div>

              <div class="subsection-title">업로드된 사진</div>
              <div class="photo-links" id="detailPhotos"></div>

              <div class="subsection-title">닥터케이 답변 히스토리</div>
              <div class="reply-history" id="replyHistory"></div>

              <div class="subsection-title">새 답변 메모</div>
              <textarea
                id="replyInput"
                placeholder="예: 필러로 가능한 방향 / 예상 난이도 / 권장 용량 범위 / 주의점 등을 솔직하게 적어줘."
              ></textarea>

              <div class="btn-row">
                <button type="button" class="btn-small btn-outline" id="clearReplyBtn">
                  입력 취소
                </button>
                <button type="button" class="btn-small btn-save" id="saveReplyBtn">
                  답변 저장
                </button>
              </div>

              <div class="status-text" id="doctorStatus"></div>
            </div>

            <div id="doctorEmptyInfo" class="status-text">
              아직 불러온 케이스가 없어요. 상단의 새로고침을 눌러 불러와줘.
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- PIN MODAL -->
    <div class="modal-backdrop" id="pinModalBackdrop">
      <div class="modal">
        <div class="modal-title" id="pinModalTitle">닥터 모드 PIN 설정</div>
        <div class="modal-text" id="pinModalText">
          처음 한 번만 6자리 숫자로 PIN을 만들어줘. 이 브라우저에서만 기억할게.
        </div>

        <div class="pin-input-row" id="pinSetupRow">
          <input
            type="password"
            inputmode="numeric"
            maxlength="6"
            id="pinNew"
            placeholder="새 PIN"
          />
          <input
            type="password"
            inputmode="numeric"
            maxlength="6"
            id="pinConfirm"
            placeholder="다시 입력"
          />
        </div>

        <div class="pin-input-row" id="pinLoginRow" style="display: none">
          <input
            type="password"
            inputmode="numeric"
            maxlength="6"
            id="pinLogin"
            placeholder="6자리 PIN"
          />
        </div>

        <div class="modal-error" id="pinError"></div>

        <div class="modal-btn-row">
          <button type="button" class="btn-cancel" id="pinCancelBtn">
            취소
          </button>
          <button type="button" class="btn-confirm" id="pinOkBtn">
            확인
          </button>
        </div>
      </div>
    </div>

    <script>
      // ----- Supabase 설정 -----
      const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
      const SUPABASE_KEY =
        "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";
      const SUPABASE_BUCKET = "drk-photos";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      );

      // ----- DOM -----
      const userSection = document.getElementById("userSection");
      const doctorSection = document.getElementById("doctorSection");
      const userModeBtn = document.getElementById("userModeBtn");
      const doctorModeBtn = document.getElementById("doctorModeBtn");
      const headerDesc = document.getElementById("headerDesc");

      const consultForm = document.getElementById("consultForm");
      const submitBtn = document.getElementById("submitBtn");
      const userStatus = document.getElementById("userStatus");

      const fieldPart = document.getElementById("fieldPart");
      const fieldConcern = document.getElementById("fieldConcern");
      const fieldGoal = document.getElementById("fieldGoal");
      const fieldChangeLevel = document.getElementById("fieldChangeLevel");
      const fieldRefNote = document.getElementById("fieldRefNote");

      const photoFront = document.getElementById("photoFront");
      const photoLeft = document.getElementById("photoLeft");
      const photoRight = document.getElementById("photoRight");
      const photoBack = document.getElementById("photoBack");

      // Doctor UI
      const caseListEl = document.getElementById("caseList");
      const doctorDetail = document.getElementById("doctorDetail");
      const detailInfo = document.getElementById("detailInfo");
      const detailPhotos = document.getElementById("detailPhotos");
      const replyHistory = document.getElementById("replyHistory");
      const replyInput = document.getElementById("replyInput");
      const clearReplyBtn = document.getElementById("clearReplyBtn");
      const saveReplyBtn = document.getElementById("saveReplyBtn");
      const doctorStatus = document.getElementById("doctorStatus");
      const doctorEmptyInfo = document.getElementById("doctorEmptyInfo");
      const reloadBtn = document.getElementById("reloadBtn");

      // PIN Modal
      const pinModalBackdrop = document.getElementById("pinModalBackdrop");
      const pinModalTitle = document.getElementById("pinModalTitle");
      const pinModalText = document.getElementById("pinModalText");
      const pinSetupRow = document.getElementById("pinSetupRow");
      const pinLoginRow = document.getElementById("pinLoginRow");
      const pinNew = document.getElementById("pinNew");
      const pinConfirm = document.getElementById("pinConfirm");
      const pinLogin = document.getElementById("pinLogin");
      const pinError = document.getElementById("pinError");
      const pinCancelBtn = document.getElementById("pinCancelBtn");
      const pinOkBtn = document.getElementById("pinOkBtn");

      let currentMode = "user";
      let doctorAuthed = false;
      let currentCase = null;
      let pinMode = "setup"; // "setup" | "login"

      function setMode(mode) {
        currentMode = mode;
        if (mode === "user") {
          userSection.style.display = "";
          doctorSection.style.display = "none";
          userModeBtn.classList.add("active");
          doctorModeBtn.classList.remove("active");
          headerDesc.style.display = "block";
        } else {
          userSection.style.display = "none";
          doctorSection.style.display = "";
          userModeBtn.classList.remove("active");
          doctorModeBtn.classList.add("active");
          headerDesc.style.display = "none";
        }
      }

      // ----- PIN MODAL -----
      function openPinSetup() {
        pinMode = "setup";
        pinModalTitle.textContent = "닥터 모드 PIN 설정";
        pinModalText.textContent =
          "처음 한 번만 6자리 숫자로 PIN을 만들어줘. 이 브라우저에서만 기억할게.";
        pinSetupRow.style.display = "flex";
        pinLoginRow.style.display = "none";
        pinNew.value = "";
        pinConfirm.value = "";
        pinError.textContent = "";
        pinModalBackdrop.style.display = "flex";
        pinNew.focus();
      }

      function openPinLogin() {
        pinMode = "login";
        pinModalTitle.textContent = "닥터 모드 PIN 입력";
        pinModalText.textContent =
          "처음 설정한 6자리 PIN을 입력하면 닥터 모드로 들어갈 수 있어.";
        pinSetupRow.style.display = "none";
        pinLoginRow.style.display = "flex";
        pinLogin.value = "";
        pinError.textContent = "";
        pinModalBackdrop.style.display = "flex";
        pinLogin.focus();
      }

      function closePinModal() {
        pinModalBackdrop.style.display = "none";
      }

      pinCancelBtn.addEventListener("click", () => {
        closePinModal();
        if (!doctorAuthed) {
          setMode("user");
        }
      });

      pinOkBtn.addEventListener("click", () => {
        if (pinMode === "setup") {
          const p1 = pinNew.value.trim();
          const p2 = pinConfirm.value.trim();
          if (!/^\d{6}$/.test(p1)) {
            pinError.textContent = "6자리 숫자로 입력해줘.";
            return;
          }
          if (p1 !== p2) {
            pinError.textContent = "두 칸의 PIN이 일치하지 않아.";
            return;
          }
          localStorage.setItem("drk_pin", p1);
          doctorAuthed = true;
          closePinModal();
          setMode("doctor");
          loadCases();
        } else {
          const saved = localStorage.getItem("drk_pin");
          const input = pinLogin.value.trim();
          if (input === saved) {
            doctorAuthed = true;
            closePinModal();
            setMode("doctor");
            loadCases();
          } else {
            pinError.textContent = "PIN이 맞지 않아.";
          }
        }
      });

      // ----- MODE BUTTONS -----
      userModeBtn.addEventListener("click", () => setMode("user"));

      doctorModeBtn.addEventListener("click", () => {
        const saved = localStorage.getItem("drk_pin");
        if (doctorAuthed) {
          setMode("doctor");
          return;
        }
        if (!saved) {
          openPinSetup();
        } else {
          openPinLogin();
        }
      });

      // ----- USER SUBMIT -----
      async function uploadPhoto(file) {
        if (!file) return null;
        const ext = file.name.split(".").pop();
        const path =
          "cases/" +
          Date.now() +
          "-" +
          Math.random().toString(36).slice(2) +
          "." +
          ext;
        const { error } = await supabaseClient.storage
          .from(SUPABASE_BUCKET)
          .upload(path, file, { cacheControl: "3600", upsert: false });

        if (error) {
          console.error("upload error", error);
          throw new Error("이미지 업로드 중 오류가 발생했어.");
        }

        const { data } = supabaseClient.storage
          .from(SUPABASE_BUCKET)
          .getPublicUrl(path);

        return data.publicUrl;
      }

      consultForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        userStatus.classList.remove("ok", "err");

        const part = fieldPart.value.trim();
        const concern = fieldConcern.value.trim();
        const goal = fieldGoal.value.trim();
        const changeLevel = fieldChangeLevel.value;
        const refnote = fieldRefNote.value.trim();

        if (!part || !concern) {
          userStatus.textContent = "관심 부위와 고민되는 부분은 꼭 적어줘.";
          userStatus.classList.add("err");
          return;
        }

        submitBtn.disabled = true;
        userStatus.textContent =
          "업로드 중입니다. 창 닫지 말고 잠시만 기다려주세요.";
        userStatus.classList.remove("err", "ok");

        try {
          const [frontUrl, leftUrl, rightUrl, backUrl] = await Promise.all([
            uploadPhoto(photoFront.files[0]),
            uploadPhoto(photoLeft.files[0]),
            uploadPhoto(photoRight.files[0]),
            uploadPhoto(photoBack.files[0]),
          ]);

          const { error } = await supabaseClient.from("cases").insert([
            {
              part,
              concern,
              goal,
              change_level: changeLevel,
              refnote,
              status: "new",
              photos_front: frontUrl,
              photos_left: leftUrl,
              photos_right: rightUrl,
              photos_back: backUrl,
              messages: [],
            },
          ]);

          if (error) {
            console.error(error);
            throw new Error("저장 중 오류가 발생했어.");
          }

          consultForm.reset();
          userStatus.textContent =
            "접수 완료! 순서대로 차트를 확인하고 답변 남길게.";
          userStatus.classList.add("ok");
        } catch (err) {
          console.error(err);
          userStatus.textContent =
            err.message || "업로드 중 알 수 없는 오류가 발생했어.";
          userStatus.classList.add("err");
        } finally {
          submitBtn.disabled = false;
        }
      });

      // ----- DOCTOR MODE: LOAD CASES -----
      async function loadCases() {
        doctorStatus.textContent = "";
        caseListEl.innerHTML = "불러오는 중...";
        doctorEmptyInfo.style.display = "none";
        doctorDetail.style.display = "none";
        currentCase = null;

        const { data, error } = await supabaseClient
          .from("cases")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          caseListEl.innerHTML = "";
          doctorEmptyInfo.style.display = "block";
          doctorEmptyInfo.textContent = "케이스를 불러오지 못했어.";
          return;
        }

        if (!data || data.length === 0) {
          caseListEl.innerHTML = "";
          doctorEmptyInfo.style.display = "block";
          doctorEmptyInfo.textContent = "아직 접수된 케이스가 없어.";
          return;
        }

        caseListEl.innerHTML = "";
        doctorEmptyInfo.style.display = "none";

        data.forEach((item) => {
          const div = document.createElement("div");
          div.className = "case-item";

          const header = document.createElement("div");
          header.className = "case-item-header";

          const left = document.createElement("div");
          const partSpan = document.createElement("span");
          partSpan.className = "case-item-part";
          partSpan.textContent = item.part || "(관심 부위 미입력)";
          left.appendChild(partSpan);

          const concernDiv = document.createElement("div");
          concernDiv.className = "case-item-concern";
          concernDiv.textContent =
            (item.concern || "").slice(0, 40) +
            (item.concern && item.concern.length > 40 ? "…" : "");
          left.appendChild(concernDiv);

          const right = document.createElement("div");
          const statusBadge = document.createElement("span");
          statusBadge.className =
            "badge " +
            (item.status === "answered" ? "badge-done" : "badge-new");
          statusBadge.textContent =
            item.status === "answered" ? "답변 완료" : "대기";
          right.appendChild(statusBadge);

          const dateSpan = document.createElement("span");
          dateSpan.className = "case-item-date";
          if (item.created_at) {
            const d = new Date(item.created_at);
            const s = `${d.getMonth() + 1}/${d.getDate()} ${String(
              d.getHours()
            ).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
            dateSpan.textContent = s;
          }
          right.appendChild(dateSpan);

          header.appendChild(left);
          header.appendChild(right);

          div.appendChild(header);

          div.addEventListener("click", () => {
            selectCase(item);
          });

          caseListEl.appendChild(div);
        });
      }

      function selectCase(item) {
        currentCase = item;
        doctorDetail.style.display = "";
        doctorStatus.textContent = "";

        // 기본 정보
        const lines = [];
        lines.push("· 관심 부위 / 키워드");
        lines.push(item.part || "-");
        lines.push("");
        lines.push("· 지금 제일 고민되는 부분");
        lines.push(item.concern || "-");
        lines.push("");
        lines.push("· 원하는 느낌 / 목표");
        lines.push(item.goal || "-");
        lines.push("");
        lines.push("· 어느 정도까지 바꾸고 싶은지");
        let levelText = "-";
        if (item.change_level === "standard") {
          levelText = "표준 (주변에서 예뻐졌네? 하는 정도)";
        } else if (item.change_level === "strong") {
          levelText = "확실한 변화 (사진에서 바로 보이는 정도)";
        } else if (item.change_level === "image-change") {
          levelText = "이미지 체인지 (완전 다른 느낌)";
        }
        lines.push(levelText);
        lines.push("");
        lines.push("· 참고 전후/이미지 메모");
        lines.push(item.refnote || "-");

        detailInfo.textContent = lines.join("\n");

        // 사진
        detailPhotos.innerHTML = "";
        const photoMap = [
          ["정면", item.photos_front],
          ["좌 45°", item.photos_left],
          ["우 45°", item.photos_right],
          ["후면", item.photos_back],
        ];
        photoMap.forEach(([label, url]) => {
          if (!url) return;
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = label;
          detailPhotos.appendChild(a);
        });
        if (detailPhotos.innerHTML === "") {
          detailPhotos.textContent = "업로드된 사진이 없어요.";
        }

        // 답변 히스토리
        replyHistory.innerHTML = "";
        const msgs = Array.isArray(item.messages) ? item.messages : [];
        if (msgs.length === 0) {
          const empty = document.createElement("div");
          empty.className = "status-text";
          empty.textContent = "아직 남긴 답변이 없어.";
          replyHistory.appendChild(empty);
        } else {
          msgs.forEach((m) => {
            const div = document.createElement("div");
            div.className = "reply-item";
            div.textContent = m.text || "";
            const t = document.createElement("time");
            if (m.created_at) {
              const d = new Date(m.created_at);
              t.textContent = `${d.getMonth() + 1}/${d.getDate()} ${String(
                d.getHours()
              ).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
            }
            div.appendChild(t);
            replyHistory.appendChild(div);
          });
        }

        replyInput.value = "";
      }

      clearReplyBtn.addEventListener("click", () => {
        replyInput.value = "";
      });

      saveReplyBtn.addEventListener("click", async () => {
        if (!currentCase) {
          doctorStatus.textContent = "먼저 케이스를 선택해줘.";
          doctorStatus.classList.add("err");
          return;
        }
        const text = replyInput.value.trim();
        if (!text) {
          doctorStatus.textContent = "새 답변 내용을 입력해줘.";
          doctorStatus.classList.add("err");
          return;
        }

        doctorStatus.textContent = "저장 중...";
        doctorStatus.classList.remove("err", "ok");
        saveReplyBtn.disabled = true;

        try {
          const msgs = Array.isArray(currentCase.messages)
            ? currentCase.messages.slice()
            : [];
          msgs.unshift({
            role: "doctor",
            text,
            created_at: new Date().toISOString(),
          });

          const { data, error } = await supabaseClient
            .from("cases")
            .update({ messages: msgs, status: "answered" })
            .eq("id", currentCase.id)
            .select()
            .single();

          if (error) {
            console.error(error);
            throw new Error("저장 중 오류가 발생했어.");
          }

          doctorStatus.textContent = "저장 완료!";
          doctorStatus.classList.add("ok");
          replyInput.value = "";
          currentCase = data;
          selectCase(currentCase);
          await loadCases();
        } catch (err) {
          console.error(err);
          doctorStatus.textContent =
            err.message || "저장 중 알 수 없는 오류가 발생했어.";
          doctorStatus.classList.add("err");
        } finally {
          saveReplyBtn.disabled = false;
        }
      });

      reloadBtn.addEventListener("click", () => {
        if (!doctorAuthed) return;
        loadCases();
      });

      // 초기 모드는 사용자
      setMode("user");
    </script>
  </body>
</html>
