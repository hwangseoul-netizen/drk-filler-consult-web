<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¥í„°ì¼€ì´ í•„ëŸ¬ ìƒë‹´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1020;
      --card: #0f172a;
      --card-soft: #111827;
      --accent: #f973b5;
      --accent-soft: #fecdd3;
      --accent-strong: #fb7185;
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --line-soft: #1f2933;
      --danger: #f97373;
      --success: #4ade80;
      --pill-bg: #020617;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background:
        radial-gradient(circle at top, #1f2937 0, transparent 55%),
        radial-gradient(circle at bottom, #0f172a 0, #030712 55%);
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 16px 96px;
    }

    /* HEADER */
    .header-card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 22px;
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      margin-bottom: 18px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .k-badge {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .k-avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #ec4899);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 12px 30px rgba(236, 72, 153, 0.6);
    }

    .k-avatar span {
      font-weight: 800;
      color: #020617;
      font-size: 20px;
    }

    .k-text-main {
      font-size: 18px;
      font-weight: 800;
    }

    .k-text-sub {
      font-size: 12px;
      color: #d1d5db;
    }

    .mode-switch {
      background: var(--pill-bg);
      border-radius: 999px;
      padding: 3px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .mode-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      color: var(--text-sub);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #020617;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(248, 113, 113, 0.55);
    }

    .header-main-title {
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 4px;
      letter-spacing: -0.02em;
    }

    .header-desc {
      font-size: 13px;
      color: #e5e7eb;
      margin: 0;
      line-height: 1.5;
    }

    .header-desc strong { color: var(--accent-soft); }

    .header-caption {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* SECTION / CARD */
    .section {
      margin-top: 18px;
    }

    .section-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 800;
    }

    .section-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), #020617);
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.85);
    }

    .field-label {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .field-help {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    textarea,
    input[type="text"],
    select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      color: #f9fafb;
      padding: 10px 11px;
      font-size: 13px;
      resize: vertical;
      min-height: 46px;
      outline: none;
      transition: border 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s;
    }

    textarea:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: #fb7185;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.7);
      background: radial-gradient(circle at top, #020617, #020617);
    }

    textarea::placeholder,
    input::placeholder {
      color: #6b7280;
    }

    .inline-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .pill-option {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-sub);
      cursor: pointer;
      background: #020617;
      transition: all 0.15s ease-out;
    }

    .pill-option.active {
      border-color: transparent;
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #020617;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(248, 113, 113, 0.6);
    }

    .file-row {
      margin-top: 8px;
    }

    .file-label {
      font-size: 12px;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .file-input {
      display: block;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .primary-btn {
      width: 100%;
      margin-top: 14px;
      border-radius: 999px;
      border: none;
      padding: 11px 16px;
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #020617;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 16px 40px rgba(248, 113, 113, 0.7);
      transition: transform 0.08s ease-out, box-shadow 0.1s ease-out, opacity 0.1s;
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 10px 28px rgba(248, 113, 113, 0.6);
    }

    .primary-btn.disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .status-text {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 8px;
    }

    /* DOCTOR MODE */
    #doctor-view { display: none; }

    .doctor-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .doctor-stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .doctor-filter-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .case-list {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .case-card {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid rgba(55, 65, 81, 0.85);
    }

    .case-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .case-title {
      font-size: 14px;
      font-weight: 700;
    }

    .case-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .status-badge {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-new {
      background: rgba(248, 113, 113, 0.16);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.7);
    }

    .status-answered {
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .status-closed {
      background: rgba(148, 163, 184, 0.14);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .case-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-top: 8px;
      font-size: 12px;
    }

    .case-label {
      color: #9ca3af;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .case-value {
      color: #e5e7eb;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .case-photo-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .photo-pill {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      text-decoration: none;
    }

    .case-actions {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .case-actions-left {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .mini-btn {
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }

    .mini-btn.primary {
      border-color: transparent;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 700;
    }

    .mini-btn.danger {
      border-color: rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 1);
    }

    /* PIN MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }

    .modal {
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(55, 65, 81, 0.85);
      max-width: 360px;
      width: 100%;
      padding: 16px 16px 14px;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.9);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .modal-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .pin-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .pin-input-row input {
      flex: 1;
      text-align: center;
      font-size: 16px;
      letter-spacing: 0.25em;
      padding: 8px 6px;
    }

    .modal-btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 700;
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #020617;
    }

    .modal-btn.ghost {
      background: #020617;
      border: 1px solid rgba(75, 85, 99, 0.9);
      color: #e5e7eb;
    }

    .pin-error {
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
      margin-bottom: 4px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.96);
      padding: 10px 13px;
      border-radius: 12px;
      font-size: 12px;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: none;
      z-index: 40;
    }

    .toast.show {
      display: block;
    }

    /* RESPONSIVE */
    @media (max-width: 640px) {
      .header-top {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-main-title { font-size: 20px; }
      .app { padding-inline: 12px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <section class="header-card">
      <div class="header-top">
        <div class="k-badge">
          <div class="k-avatar"><span>K</span></div>
          <div>
            <div class="k-text-main">ë‹¥í„°ì¼€ì´ í•„ëŸ¬ ìƒë‹´</div>
            <div class="k-text-sub">ì „ì‹  í•„ëŸ¬ ì „ë¬¸ ì˜¨ë¼ì¸ í”„ë¦¬ ìƒë‹´</div>
          </div>
        </div>
        <div class="mode-switch">
          <button class="mode-btn active" id="btn-mode-user">
            ì‚¬ìš©ì ëª¨ë“œ
          </button>
          <button class="mode-btn" id="btn-mode-doctor">
            ë‹¥í„° ëª¨ë“œ
          </button>
        </div>
      </div>
      <div>
        <h1 class="header-main-title">â€œì´ê±° í•„ëŸ¬ë¡œ ë¼ìš”? ì–¼ë§ˆë‚˜ ë„£ì–´ì•¼ í•´ìš”?â€</h1>
        <p class="header-desc">
          ì „ì‹ ì„ í•„ëŸ¬ë¡œ ë‹¤ë¤„ì˜¨ ë‹¥í„°ì¼€ì´ê°€ ì˜¨ë¼ì¸ì—ì„œ ë°©í–¥ì„ ì¡ì•„ì£¼ëŠ” í”„ë¦¬ ìƒë‹´ì…ë‹ˆë‹¤.
          <strong>ì‹¤ì‹œê°„ ì±„íŒ…ì€ ì•„ë‹ˆì§€ë§Œ, íƒ‘ í‹°ì–´ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ë§›ì´ ìˆì–´!</strong>
        </p>
        <p class="header-caption">
          ì‚¬ì§„ê³¼ ê³ ë¯¼ì„ ë‚¨ê¸°ë©´, ë‹¥í„°ì¼€ì´ê°€ ì°¨íŠ¸ë¥¼ ë³´ë“¯ í•˜ë‚˜ì”© ì—´ì–´ë³´ê³  ë‹µë³€ì„ ë‚¨ê¹ë‹ˆë‹¤.
        </p>
      </div>
    </section>

    <!-- USER MODE -->
    <div id="user-view">
      <form id="user-form">
        <section class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">1ë‹¨ê³„ Â· ì–´ë””ê°€ ì œì¼ ê³ ë¯¼ì´ì•¼?</div>
              <div class="section-sub">ê´€ì‹¬ ë¶€ìœ„ / í‚¤ì›Œë“œ</div>
            </div>
          </div>
          <div class="card">
            <div class="field-label">ê´€ì‹¬ ë¶€ìœ„ (ììœ  ì…ë ¥)</div>
            <div class="field-help">ì˜ˆ: ê³¨ë°˜í•„ëŸ¬, í™ë”¥, ì–´ê¹¨, ê°€ìŠ´ê³¨ ë“±</div>
            <textarea id="field-part" placeholder="ì˜ˆ: ê³¨ë°˜í•„ëŸ¬, í™ë”¥, ì–´ê¹¨, ê°€ìŠ´ê³¨ ë“±"></textarea>

            <div style="height:10px;"></div>

            <div class="field-label">ì§€ê¸ˆ ì œì¼ ê³ ë¯¼ë˜ëŠ” ë¶€ë¶„</div>
            <div class="field-help">ì˜ˆ: ê³¨ë°˜ì´ ë„ˆë¬´ ì–‡ì•„ì„œ ë¼ì¸ì´ ì—†ì–´ìš” ë“±</div>
            <textarea id="field-concern" placeholder="ì˜ˆ: ê³¨ë°˜ì´ ë„ˆë¬´ ì–‡ì•„ì„œ ë¼ì¸ì´ ì—†ì–´ìš” ë“±"></textarea>
          </div>
        </section>

        <section class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">2ë‹¨ê³„ Â· ë°”ë€Œì—ˆìœ¼ë©´ í•˜ëŠ” ëŠë‚Œ/ì´ë¯¸ì§€</div>
              <div class="section-sub">ì›í•˜ëŠ” ë¶„ìœ„ê¸° / ì´ë¯¸ì§€</div>
            </div>
          </div>
          <div class="card">
            <div class="field-label">ì›í•˜ëŠ” ëŠë‚Œ / ëª©í‘œ</div>
            <div class="field-help">
              ì˜ˆ: ìì—°ìŠ¤ëŸ½ê²Œ ê³¨ë°˜ ë¼ìš´ë“œ ë³¼ë¥¨ / ì†ë“±ì€ ë‚˜ì´í‹°ë§Œ ì¤„ì–´ë“  ì •ë„ ë“±
            </div>
            <textarea id="field-goal" placeholder="ì˜ˆ: ìì—°ìŠ¤ëŸ½ê²Œ ê³¨ë°˜ ë¼ìš´ë“œ ë³¼ë¥¨ / ì†ë“±ì€ ë‚˜ì´í‹°ë§Œ ì¤„ì–´ë“  ì •ë„ ë“±"></textarea>

            <div style="height:12px;"></div>
            <div class="field-label">ì–´ëŠ ì •ë„ê¹Œì§€ ë°”ê¾¸ê³  ì‹¶ì–´?</div>
            <div class="field-help">ëŒ€ëµ ëŠë‚Œì´ì•¼. ë‚˜ì¤‘ì— ì‹¤ì œ ê¶Œì¥ ìš©ëŸ‰ì€ ì¼€ì´ìŠ¤ ë³´ê³  ë‹¤ì‹œ ì¡ì•„ì¤„ê²Œ.</div>

            <select id="field-change">
              <option value="subtle">ì‚´ì§ í‹°ë§Œ</option>
              <option value="standard" selected>í‘œì¤€ (ì£¼ë³€ì—ì„œ ì˜ˆë»ì¡Œë„¤? í•˜ëŠ” ì •ë„)</option>
              <option value="dramatic">í™•ì‹¤í•˜ê²Œ (ì‚¬ì§„/ì˜ìƒì—ì„œë„ í‹° ë‚˜ëŠ” ì •ë„)</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">3ë‹¨ê³„ Â· ì°¸ê³  ì´ë¯¸ì§€ & ë©”ëª¨</div>
              <div class="section-sub">
                ë‹¤ë¥¸ ë³‘ì› ì „í›„, ì…€ì¹´, ë³´ì • ì´ë¯¸ì§€ ë“± ë­ë“  ì¢‹ì•„. í¸í•˜ê²Œ ì˜¬ë ¤ì¤˜.
              </div>
            </div>
          </div>
          <div class="card">
            <div class="field-label">ì°¸ê³  ì „í›„/ì´ë¯¸ì§€ ë©”ëª¨</div>
            <div class="field-help">
              ì˜ˆ: ì¸ìŠ¤íƒ€ì—ì„œ ë³¸ ì „í›„ ëŠë‚Œ / ë³¸ì¸ì´ ë³´ì •í•œ í›„ì‚¬ì§„ ì„¤ëª… / ì…€ëŸ½ ì´ë¯¸ì§€ ë§í¬ ë“±
            </div>
            <textarea id="field-refnote" placeholder="ì˜ˆ: ì¸ìŠ¤íƒ€ì—ì„œ ë³¸ ì „í›„ ëŠë‚Œ / ë³¸ì¸ì´ ë³´ì •í•œ í›„ì‚¬ì§„ ì„¤ëª… ë“±"></textarea>

            <div style="height:12px;"></div>
            <div class="field-label">ì‚¬ì§„ ì—…ë¡œë“œ (ì •ë©´ / ì¢Œ45 / ìš°45 / í›„ë©´)</div>
            <div class="field-help">
              ì§€ê¸ˆì€ í…ŒìŠ¤íŠ¸ë¼ 4ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•´. ì–¼êµ´/ë°”ë”” ëª¨ë‘ ê°€ëŠ¥. ë¯¼ê°í•˜ë©´ ì–¼êµ´ì€ ê°€ë ¤ë„ ë¼.
            </div>

            <div class="file-row">
              <div class="file-label">ì •ë©´</div>
              <input class="file-input" type="file" id="photo-front" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label">ì¢Œ 45Â°</div>
              <input class="file-input" type="file" id="photo-left" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label">ìš° 45Â°</div>
              <input class="file-input" type="file" id="photo-right" accept="image/*" />
            </div>
            <div class="file-row">
              <div class="file-label">í›„ë©´</div>
              <input class="file-input" type="file" id="photo-back" accept="image/*" />
            </div>

            <button type="submit" class="primary-btn" id="btn-submit">
              ìƒë‹´ ë³´ë‚´ê¸°
            </button>
            <div class="status-text" id="submit-status">
              ì—…ë¡œë“œëŠ” Wi-Fi ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ ì´ˆ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆì–´. ì°½ ë‹«ì§€ ë§ê³  ì ê¹ë§Œ ê¸°ë‹¤ë ¤ì¤˜.
            </div>
          </div>
        </section>
      </form>
    </div>

    <!-- DOCTOR MODE -->
    <div id="doctor-view">
      <section class="section">
        <div class="section-title-row">
          <div>
            <div class="section-title">ë‹¥í„°ì¼€ì´ ëŒ€ê¸°í•¨</div>
            <div class="section-sub">
              ì „êµ­ì—ì„œ ì˜¬ë¼ì˜¨ â€œì´ê±° í•„ëŸ¬ë¡œ ë¼ìš”?â€ ì¼€ì´ìŠ¤ë“¤ì„ ì°¨íŠ¸ ë³´ë“¯ í•˜ë‚˜ì”© ì—´ì–´ë³´ëŠ” í™”ë©´ì´ì•¼.
            </div>
          </div>
          <div class="doctor-stat-pill">
            <span>ğŸ©º</span><span id="doctor-summary">ëŒ€ê¸° ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>
          </div>
        </div>

        <div class="card">
          <div class="doctor-header-row">
            <div class="section-sub">
              ì‹¤ì‹œê°„ ì±„íŒ…ì´ ì•„ë‹ˆë¼, <strong>ë¹„ëŒ€ë©´ ì°¨íŠ¸ ë¦¬ë·°</strong>ì²˜ëŸ¼ ì‚¬ìš©í•œë‹¤ê³  ìƒê°í•˜ë©´ ë¼.
            </div>
            <button class="mini-btn" id="btn-refresh">ìƒˆë¡œê³ ì¹¨</button>
          </div>

          <div class="doctor-filter-row">
            <button class="mini-btn primary" data-filter="all">ì „ì²´</button>
            <button class="mini-btn" data-filter="new">ì‹ ê·œ</button>
            <button class="mini-btn" data-filter="answered">ë‹µë³€ ì™„ë£Œ</button>
            <button class="mini-btn" data-filter="closed">ë³´ê´€</button>
          </div>

          <div class="case-list" id="case-list">
            <!-- ì¼€ì´ìŠ¤ ì¹´ë“œë“¤ ì—¬ê¸° ë Œë”ë§ -->
          </div>

          <div class="status-text" id="doctor-empty" style="display:none;">
            ì•„ì§ ì ‘ìˆ˜ëœ ì¼€ì´ìŠ¤ê°€ ì—†ì–´. ë§í¬ ë¿Œë¦¬ë©´ ê¸ˆë°© ì°° ê±°ì•¼.
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- PIN MODAL -->
  <div class="modal-backdrop" id="pin-modal">
    <div class="modal">
      <div class="modal-title" id="pin-title">ë‹¥í„° ëª¨ë“œ PIN ì„¤ì •</div>
      <div class="modal-sub" id="pin-sub">
        ì²˜ìŒ í•œ ë²ˆë§Œ 6ìë¦¬ ìˆ«ìë¡œ PINì„ ë§Œë“¤ì–´. ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê¸°ì–µí•´ë‘˜ê²Œ.
      </div>

      <div class="pin-input-row" id="pin-row-setup">
        <input id="pin-new" maxlength="6" inputmode="numeric" placeholder="ìƒˆ PIN" />
        <input id="pin-confirm" maxlength="6" inputmode="numeric" placeholder="ë‹¤ì‹œ ì…ë ¥" />
      </div>

      <div class="pin-input-row" id="pin-row-login" style="display:none;">
        <input id="pin-login" maxlength="6" inputmode="numeric" placeholder="6ìë¦¬ PIN" />
      </div>

      <div class="pin-error" id="pin-error"></div>

      <div class="modal-btn-row">
        <button class="modal-btn ghost" id="pin-cancel">ì·¨ì†Œ</button>
        <button class="modal-btn primary" id="pin-ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Supabase ì„¤ì • =====
    const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
    const SUPABASE_ANON = "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";
    const STORAGE_BUCKET = "drk-photos";

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ===== ëª¨ë“œ ì „í™˜ =====
    const userView = document.getElementById("user-view");
    const doctorView = document.getElementById("doctor-view");
    const btnUser = document.getElementById("btn-mode-user");
    const btnDoctor = document.getElementById("btn-mode-doctor");

    let doctorUnlocked = false;
    let doctorFilter = "all";
    let cachedCases = [];

    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2000);
    }

    function switchMode(mode) {
      if (mode === "user") {
        userView.style.display = "block";
        doctorView.style.display = "none";
        btnUser.classList.add("active");
        btnDoctor.classList.remove("active");
      } else {
        btnUser.classList.remove("active");
        btnDoctor.classList.add("active");
        if (!doctorUnlocked) {
          openPinModal();
        } else {
          userView.style.display = "none";
          doctorView.style.display = "block";
          loadCases();
        }
      }
    }

    btnUser.addEventListener("click", () => switchMode("user"));
    btnDoctor.addEventListener("click", () => switchMode("doctor"));

    // ===== PIN ëª¨ë‹¬ =====
    const pinModal = document.getElementById("pin-modal");
    const pinTitle = document.getElementById("pin-title");
    const pinSub = document.getElementById("pin-sub");
    const pinRowSetup = document.getElementById("pin-row-setup");
    const pinRowLogin = document.getElementById("pin-row-login");
    const pinNew = document.getElementById("pin-new");
    const pinConfirm = document.getElementById("pin-confirm");
    const pinLogin = document.getElementById("pin-login");
    const pinError = document.getElementById("pin-error");
    const pinBtnOk = document.getElementById("pin-ok");
    const pinBtnCancel = document.getElementById("pin-cancel");

    function openPinModal() {
      const saved = localStorage.getItem("drk_doctor_pin");
      pinError.textContent = "";
      if (saved) {
        // ë¡œê·¸ì¸ ëª¨ë“œ
        pinTitle.textContent = "ë‹¥í„° ëª¨ë“œ PIN ì…ë ¥";
        pinSub.textContent = "ë‹¥í„°ì¼€ì´ ë³¸ì¸ë§Œ ë“¤ì–´ì˜¤ëŠ” ì°¨íŠ¸ì•¼. 6ìë¦¬ PINì„ ì…ë ¥í•´ì¤˜.";
        pinRowSetup.style.display = "none";
        pinRowLogin.style.display = "flex";
        pinLogin.value = "";
      } else {
        // ìµœì´ˆ ì„¤ì • ëª¨ë“œ
        pinTitle.textContent = "ë‹¥í„° ëª¨ë“œ PIN ì„¤ì •";
        pinSub.textContent = "ì²˜ìŒ í•œ ë²ˆë§Œ 6ìë¦¬ ìˆ«ìë¡œ PINì„ ë§Œë“¤ì–´. ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê¸°ì–µí•´ë‘˜ê²Œ.";
        pinRowSetup.style.display = "flex";
        pinRowLogin.style.display = "none";
        pinNew.value = "";
        pinConfirm.value = "";
      }
      pinModal.style.display = "flex";
    }

    function closePinModal() {
      pinModal.style.display = "none";
    }

    pinBtnCancel.addEventListener("click", () => {
      closePinModal();
      // ì‚¬ìš©ì ëª¨ë“œë¡œ ëŒë¦¬ê¸°
      btnUser.classList.add("active");
      btnDoctor.classList.remove("active");
      userView.style.display = "block";
      doctorView.style.display = "none";
    });

    pinBtnOk.addEventListener("click", () => {
      const saved = localStorage.getItem("drk_doctor_pin");
      if (saved) {
        const val = pinLogin.value.trim();
        if (!/^\d{6}$/.test(val)) {
          pinError.textContent = "6ìë¦¬ ìˆ«ìë¡œë§Œ ì…ë ¥í•´ì¤˜.";
          return;
        }
        if (val !== saved) {
          pinError.textContent = "PINì´ ë§ì§€ ì•Šì•„.";
          return;
        }
        doctorUnlocked = true;
        closePinModal();
        userView.style.display = "none";
        doctorView.style.display = "block";
        loadCases();
      } else {
        const a = pinNew.value.trim();
        const b = pinConfirm.value.trim();
        if (!/^\d{6}$/.test(a) || !/^\d{6}$/.test(b)) {
          pinError.textContent = "PINì€ 6ìë¦¬ ìˆ«ìë§Œ ê°€ëŠ¥í•´.";
          return;
        }
        if (a !== b) {
          pinError.textContent = "ë‘ PINì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„.";
          return;
        }
        localStorage.setItem("drk_doctor_pin", a);
        doctorUnlocked = true;
        closePinModal();
        userView.style.display = "none";
        doctorView.style.display = "block";
        showToast("ë‹¥í„° PIN ì„¤ì • ì™„ë£Œ!");
        loadCases();
      }
    });

    // ===== ì‚¬ìš©ì ëª¨ë“œ: ì—…ë¡œë“œ =====
    const form = document.getElementById("user-form");
    const btnSubmit = document.getElementById("btn-submit");
    const submitStatus = document.getElementById("submit-status");

    function getFile(id) {
      const el = document.getElementById(id);
      return el && el.files && el.files[0] ? el.files[0] : null;
    }

    async function uploadPhoto(file, caseId, position) {
      if (!file) return null;
      const ext = file.name.split(".").pop() || "jpg";
      const path = `cases/${caseId}/${position}.${ext}`;
      const { error } = await db.storage.from(STORAGE_BUCKET).upload(path, file, {
        upsert: true,
      });
      if (error) {
        console.error("upload error", error);
        throw new Error("ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
      }
      const { data } = db.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      return data.publicUrl;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const part = document.getElementById("field-part").value.trim();
      const concern = document.getElementById("field-concern").value.trim();
      const goal = document.getElementById("field-goal").value.trim();
      const changeLevel = document.getElementById("field-change").value;
      const refnote = document.getElementById("field-refnote").value.trim();

      if (!part || !concern) {
        showToast("ê´€ì‹¬ ë¶€ìœ„ë‘ ê³ ë¯¼ë˜ëŠ” ë¶€ë¶„ì€ ê¼­ ì ì–´ì¤˜!");
        return;
      }

      btnSubmit.classList.add("disabled");
      btnSubmit.textContent = "ì—…ë¡œë“œ ì¤‘â€¦";
      submitStatus.textContent = "ì‚¬ì§„ ì—…ë¡œë“œ + ì°¨íŠ¸ ì €ì¥ ì¤‘ì´ì•¼. ì°½ ë‹«ì§€ ë§ê³  ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜.";

      try {
        const caseId =
          (window.crypto && crypto.randomUUID && crypto.randomUUID()) ||
          "case_" + Date.now();

        const frontFile = getFile("photo-front");
        const leftFile = getFile("photo-left");
        const rightFile = getFile("photo-right");
        const backFile = getFile("photo-back");

        const [frontUrl, leftUrl, rightUrl, backUrl] = await Promise.all([
          uploadPhoto(frontFile, caseId, "front"),
          uploadPhoto(leftFile, caseId, "left"),
          uploadPhoto(rightFile, caseId, "right"),
          uploadPhoto(backFile, caseId, "back"),
        ]);

        const { error } = await db.from("cases").insert({
          id: caseId,
          part,
          concern,
          goal,
          change_level: changeLevel,
          refnote,
          status: "new",
          photos_front: frontUrl,
          photos_left: leftUrl,
          photos_right: rightUrl,
          photos_back: backUrl,
          messages: [
            {
              role: "user",
              text: "ì˜¨ë¼ì¸ ìƒë‹´ ì ‘ìˆ˜",
              created_at: new Date().toISOString(),
            },
          ],
        });

        if (error) {
          console.error(error);
          throw new Error("Supabaseì— ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }

        form.reset();
        submitStatus.textContent = "ì ‘ìˆ˜ ì™„ë£Œ! ë‹¥í„°ì¼€ì´ê°€ ì°¨íŠ¸ì— ë„£ì–´ë‘ê³  ìˆœì„œëŒ€ë¡œ ë³¼ê²Œ.";
        showToast("ìƒë‹´ì´ ì˜ ì ‘ìˆ˜ëì–´ ğŸ™Œ");
      } catch (err) {
        console.error(err);
        submitStatus.textContent =
          err.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì¤˜.";
        showToast("ì—ëŸ¬ê°€ ë‚¬ì–´. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
      } finally {
        btnSubmit.classList.remove("disabled");
        btnSubmit.textContent = "ìƒë‹´ ë³´ë‚´ê¸°";
      }
    });

    // ===== ë‹¥í„° ëª¨ë“œ: ì¼€ì´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° / ë Œë”ë§ =====
    const caseListEl = document.getElementById("case-list");
    const doctorSummary = document.getElementById("doctor-summary");
    const doctorEmpty = document.getElementById("doctor-empty");
    const btnRefresh = document.getElementById("btn-refresh");

    function formatDateTime(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "-";
      const mm = (d.getMonth() + 1).toString().padStart(2, "0");
      const dd = d.getDate().toString().padStart(2, "0");
      const hh = d.getHours().toString().padStart(2, "0");
      const mi = d.getMinutes().toString().padStart(2, "0");
      return `${mm}/${dd} ${hh}:${mi}`;
    }

    function renderCases() {
      caseListEl.innerHTML = "";
      let list = cachedCases.slice();
      if (doctorFilter !== "all") {
        list = list.filter((c) => (c.status || "new") === doctorFilter);
      }

      if (!list.length) {
        doctorEmpty.style.display = "block";
        return;
      }
      doctorEmpty.style.display = "none";

      list.forEach((c) => {
        const card = document.createElement("div");
        card.className = "case-card";

        const status = c.status || "new";
        let statusClass = "status-new";
        let statusLabel = "ì‹ ê·œ";
        if (status === "answered") {
          statusClass = "status-answered";
          statusLabel = "ë‹µë³€ ì™„ë£Œ";
        } else if (status === "closed") {
          statusClass = "status-closed";
          statusLabel = "ë³´ê´€";
        }

        card.innerHTML = `
          <div class="case-top-row">
            <div>
              <div class="case-title">${c.part || "ë¶€ìœ„ ë¯¸ì…ë ¥"}</div>
              <div class="case-meta">
                ì ‘ìˆ˜: ${formatDateTime(c.created_at)} Â· ë‚œì´ë„: ${c.change_level || "-"}
              </div>
            </div>
            <div class="status-badge ${statusClass}">${statusLabel}</div>
          </div>

          <div class="case-grid">
            <div>
              <div class="case-label">ì£¼ìš” ê³ ë¯¼</div>
              <div class="case-value">${(c.concern || "").substring(0,120) || "-"}</div>
            </div>
            <div>
              <div class="case-label">ë°”ë¼ëŠ” ëŠë‚Œ</div>
              <div class="case-value">${(c.goal || "").substring(0,120) || "-"}</div>
            </div>
            <div>
              <div class="case-label">ì°¸ê³  ë©”ëª¨</div>
              <div class="case-value">${(c.refnote || "").substring(0,120) || "-"}</div>
            </div>
            <div>
              <div class="case-label">ID</div>
              <div class="case-value" style="font-size:10px; color:#6b7280;">${c.id}</div>
            </div>
          </div>
        `;

        const photoRow = document.createElement("div");
        photoRow.className = "case-photo-row";

        [
          ["ì •ë©´", c.photos_front],
          ["ì¢Œ45", c.photos_left],
          ["ìš°45", c.photos_right],
          ["í›„ë©´", c.photos_back],
        ].forEach(([label, url]) => {
          if (!url) return;
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.className = "photo-pill";
          a.textContent = label + " ë³´ê¸°";
          photoRow.appendChild(a);
        });

        if (photoRow.childElementCount) {
          card.appendChild(photoRow);
        }

        const actions = document.createElement("div");
        actions.className = "case-actions";

        const left = document.createElement("div");
        left.className = "case-actions-left";

        const btnAnswer = document.createElement("button");
        btnAnswer.type = "button";
        btnAnswer.className = "mini-btn primary";
        btnAnswer.textContent = "ê°„ë‹¨ ë‹µë³€ ë‚¨ê¸°ê¸°";
        btnAnswer.addEventListener("click", () => openQuickAnswer(c));

        const btnClose = document.createElement("button");
        btnClose.type = "button";
        btnClose.className = "mini-btn";
        btnClose.textContent = "ë³´ê´€";
        btnClose.addEventListener("click", () => updateStatus(c.id, "closed"));

        left.appendChild(btnAnswer);
        left.appendChild(btnClose);

        const right = document.createElement("div");
        right.innerHTML = `<span class="case-meta">ìƒíƒœ: ${statusLabel}</span>`;

        actions.appendChild(left);
        actions.appendChild(right);
        card.appendChild(actions);

        caseListEl.appendChild(card);
      });
    }

    async function loadCases() {
      doctorSummary.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
      caseListEl.innerHTML = "";
      doctorEmpty.style.display = "none";

      const { data, error } = await db
        .from("cases")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        doctorSummary.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
        showToast("ì¼€ì´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
        return;
      }

      cachedCases = data || [];
      const total = cachedCases.length;
      const newCnt = cachedCases.filter((c) => (c.status || "new") === "new").length;
      doctorSummary.textContent = `ì´ ${total} ì¼€ì´ìŠ¤ Â· ì‹ ê·œ ${newCnt}`;
      renderCases();
    }

    async function updateStatus(id, status) {
      const { error } = await db
        .from("cases")
        .update({ status })
        .eq("id", id);

      if (error) {
        console.error(error);
        showToast("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
        return;
      }
      showToast("ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´.");
      await loadCases();
    }

    function openQuickAnswer(caseRow) {
      const msg = prompt(
        "ê°„ë‹¨í•œ ì½”ë©˜íŠ¸ / ê¶Œì¥ ë°©í–¥ì„ ì ì–´ì¤˜.\n(ì˜ˆ: í•„ëŸ¬ë¡œ ê°€ëŠ¥, í‘œì¤€ ê¸°ì¤€ 20â€“30cc / ë‚œì´ë„ ì¤‘ìƒ ì •ë„)"
      );
      if (!msg) return;

      const now = new Date().toISOString();
      const messages = Array.isArray(caseRow.messages) ? caseRow.messages.slice() : [];
      messages.push({ role: "doctor", text: msg, created_at: now });

      db.from("cases")
        .update({ status: "answered", messages })
        .eq("id", caseRow.id)
        .then(({ error }) => {
          if (error) {
            console.error(error);
            showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
          } else {
            showToast("ë‹¥í„° ë©”ëª¨ ì €ì¥ ì™„ë£Œ!");
            loadCases();
          }
        });
    }

    // í•„í„° ë²„íŠ¼
    document.querySelectorAll(".doctor-filter-row .mini-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".doctor-filter-row .mini-btn")
          .forEach((b) => b.classList.remove("primary"));
        btn.classList.add("primary");
        doctorFilter = btn.getAttribute("data-filter");
        renderCases();
      });
    });

    btnRefresh.addEventListener("click", loadCases);

    // ì²« ë¡œë”©ì€ ì‚¬ìš©ì ëª¨ë“œ
    switchMode("user");
  </script>
</body>
</html>
