<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¥í„°ì¼€ì´ í•„ëŸ¬ ìƒë‹´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f7f7fa;
      --card: #ffffff;
      --primary: #ff4fa3;
      --primary-soft: #ffe4f2;
      --text-main: #222222;
      --text-sub: #7a7a7a;
      --border-soft: #e2e2e8;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--text-main);
    }
    .app {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .profile {
      background: var(--primary);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    .toggle {
      display: flex;
      background: var(--primary-soft);
      padding: 4px;
      border-radius: 20px;
    }
    .toggle button {
      flex: 1;
      border: 0;
      background: transparent;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 14px;
      cursor: pointer;
      color: #555;
    }
    .toggle .active {
      background: var(--primary);
      color: white;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      border: 1px solid var(--border-soft);
    }
    .label {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .input, textarea, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font-size: 15px;
      background: white;
    }
    textarea {
      height: 90px;
      resize: none;
    }
    .file-area {
      margin-top: 6px;
      margin-bottom: 8px;
    }
    .submit-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: 0;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
    }
    #loadingText {
      margin-top: 14px;
      font-size: 14px;
      color: var(--primary);
      text-align: center;
      display: none;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <div class="header-left">
        <div class="profile">K</div>
        <strong>ë‹¥í„°ì¼€ì´ í•„ëŸ¬ ìƒë‹´</strong>
      </div>

      <div class="toggle">
        <button id="userModeBtn" class="active">ì‚¬ìš©ì ëª¨ë“œ</button>
        <button id="doctorModeBtn">ë‹¥í„° ëª¨ë“œ</button>
      </div>
    </header>

    <p style="line-height:1.6; font-size:15px; margin-bottom:20px;">
      â€œì´ê±° í•„ëŸ¬ë¡œ ë¼ìš”? ì–¼ë§ˆë‚˜ ë„£ì–´ì•¼ í•´ìš”?â€<br>
      ì „ì‹ ì„ í•„ëŸ¬ë¡œ ë‹¤ë¤„ì˜¨ ë‹¥í„°ì¼€ì´ê°€ ì˜¨ë¼ì¸ì—ì„œ ë°©í–¥ì„ ì¡ì•„ì£¼ëŠ” ìƒë‹´ì…ë‹ˆë‹¤.
    </p>

    <!-- STEP 1 -->
    <div class="card">
      <div class="label">1ë‹¨ê³„ Â· ì–´ë””ê°€ ê³ ë¯¼ì´ì•¼?</div>
      <input id="part" class="input" placeholder="ì˜ˆ: ê³¨ë°˜í•„ëŸ¬, í™ë”¥, ì–´ê¹¨, ê°€ìŠ´ê³¨ ë“±">
      <textarea id="concern" placeholder="ì˜ˆ: ê³¨ë°˜ì´ ë„ˆë¬´ ì–‡ì•„ì„œ ë¼ì¸ì´ ì—†ì–´ìš” ë“±"></textarea>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <div class="label">2ë‹¨ê³„ Â· ë°”ë€Œì—ˆìœ¼ë©´ í•˜ëŠ” ëŠë‚Œ</div>
      <textarea id="goal" placeholder="ì˜ˆ: ìì—°ìŠ¤ëŸ¬ìš´ ë³¼ë¥¨, ë¼ìš´ë“œ ëŠë‚Œ ë“±"></textarea>
    </div>

    <!-- STEP 3 -->
    <div class="card">
      <div class="label">3ë‹¨ê³„ Â· ì–´ëŠ ì •ë„ê¹Œì§€ ë°”ê¾¸ê³  ì‹¶ì–´?</div>
      <select id="changeLevel">
        <option value="soft">ì„ íƒ</option>
        <option value="soft">ì‚´ì§ í‹°ë§Œ</option>
        <option value="standard">ì ë‹¹í•˜ê²Œ</option>
        <option value="hard">í™•ì‹¤í•˜ê²Œ</option>
      </select>
    </div>

    <!-- STEP 4 -->
    <div class="card">
      <div class="label">ì‚¬ì§„ ì—…ë¡œë“œ (ì •ë©´ / ì¢Œ45 / ìš°45 / í›„ë©´)</div>
      <div class="file-area">
        <input type="file" id="photo_front">
      </div>
      <div class="file-area">
        <input type="file" id="photo_left">
      </div>
      <div class="file-area">
        <input type="file" id="photo_right">
      </div>
      <div class="file-area">
        <input type="file" id="photo_back">
      </div>
    </div>

    <button class="submit-btn" onclick="sendConsult()">ìƒë‹´ ë³´ë‚´ê¸°</button>

    <div id="loadingText">ì—…ë¡œë“œ ì¤‘â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜!</div>

  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- MAIN LOGIC -->
  <script>
    const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
    const SUPABASE_KEY = "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function uploadToSupabase(file, name) {
      if (!file) return null;

      const ext = file.name.split(".").pop();
      const fileName = `${Date.now()}_${name}.${ext}`;

      const { error } = await supabaseClient.storage
        .from("drk-photos")
        .upload(fileName, file);

      if (error) {
        alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì¤˜ğŸ™");
        console.log(error);
        return null;
      }

      const { data } = supabaseClient.storage
        .from("drk-photos")
        .getPublicUrl(fileName);

      return data.publicUrl;
    }

    async function sendConsult() {
      document.getElementById("loadingText").style.display = "block";

      const part = document.getElementById("part").value;
      const concern = document.getElementById("concern").value;
      const goal = document.getElementById("goal").value;
      const changeLevel = document.getElementById("changeLevel").value;

      const front = document.getElementById("photo_front").files[0];
      const left = document.getElementById("photo_left").files[0];
      const right = document.getElementById("photo_right").files[0];
      const back = document.getElementById("photo_back").files[0];

      const frontUrl = await uploadToSupabase(front, "front");
      const leftUrl = await uploadToSupabase(left, "left");
      const rightUrl = await uploadToSupabase(right, "right");
      const backUrl = await uploadToSupabase(back, "back");

      const { error } = await supabaseClient.from("cases").insert({
        part,
        concern,
        goal,
        change_level: changeLevel,
        photos_front: frontUrl,
        photos_left: leftUrl,
        photos_right: rightUrl,
        photos_back: backUrl,
        status: "new",
        messages: []
      });

      document.getElementById("loadingText").style.display = "none";

      if (error) {
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´. ë‹¤ì‹œ ì‹œë„í•´ì¤˜!");
        console.log(error);
        return;
      }

      alert("ìƒë‹´ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ëì–´! ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì¤˜ ğŸ™");
    }
  </script>

</body>
</html>
